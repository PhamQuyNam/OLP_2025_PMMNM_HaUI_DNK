services:
  gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8000:80"  # Map cổng 8000 của máy bạn vào cổng 80 của Nginx
    networks:
      - main-network
    depends_on:
      - auth-service
      - orion

  auth-service:
    build: ./auth-service
    container_name: auth-service
    networks:
      - main-network
    env_file: .env
    depends_on:
      - postgis
    environment:
      - PORT=3001

  data-service:
    build: ./data-service
    container_name: data-service
    networks:
      - main-network
    env_file: .env
    depends_on:
      - postgis
    environment:
      - PORT=3002

  weather-realtime-service:
    build: ./weather-realtime-service
    container_name: weather-service
    networks:
      - main-network
    env_file: .env
    environment:
      - PORT=3003
      - ORION_HOST=http://orion:1026

  report-service:
    build: ./report-service
    container_name: report-service
    networks:
      - main-network
    env_file: .env
    environment:
      - PORT=3004
      - ORION_HOST=http://orion:1026

  alert-service:
    build: ./alert-service
    container_name: alert-service
    networks:
      - main-network
    env_file: .env
    depends_on:
      - postgis
    environment:
      - PORT=3005
      - ORION_HOST=http://orion:1026

  safety-service:
    build: ./safety-service
    container_name: safety-service
    networks: [ main-network ]
    env_file: .env
    depends_on:
      - postgis
    environment:
      - PORT=3006

  swagger-ui:
    image: swaggerapi/swagger-ui
    container_name: swagger-ui
    networks:
      - main-network
    environment:
      # Cấu hình danh sách các file JSON từ các service con
      # URL phải dùng tên container (nội bộ docker)
        URLS: "[
        { url: 'http://localhost:8000/api/auth/api-docs.json', name: '1. Auth Service' },
        { url: 'http://localhost:8000/api/map/api-docs.json', name: '2. Map API (Data Service)' },
        { url: 'http://localhost:8000/api/weather/api-docs.json', name: '3. Weather Service' },
        { url: 'http://localhost:8000/api/reports/api-docs.json', name: '4. Report Service' },
        { url: 'http://localhost:8000/api/alerts/api-docs.json', name: '5. Alert Service' },
        { url: 'http://localhost:8000/api/safety/api-docs.json', name: '6. Safety Service' },
        ]"

  # 1. MongoDB - Cơ sở dữ liệu cho Orion Context Broker
  mongo:
    image: mongo:4.4
    hostname: mongo
    container_name: db-mongo
    ports:
      - "27017:27017"
    networks:
      - main-network
    command: --nojournal

  # 2. Fiware Orion Context Broker - Cốt lõi quản lý ngữ cảnh NGSI-LD
  orion:
    image: fiware/orion-ld:latest
    hostname: orion
    container_name: fiware-orion
    restart: always
    command: -dbhost mongo -logLevel DEBUG
    depends_on:
      - mongo
    networks:
      - main-network
    ports:
      - "1026:1026"
    environment:
      - ORION_MONGO_HOST=mongo
      - ORION_MONGO_PORT=27017

  # 3. PostGIS - Cơ sở dữ liệu không gian cho dữ liệu tĩnh (Vùng nguy cơ)
  postgis:
    image: postgis/postgis:latest
    hostname: postgis
    container_name: db-postgis
    ports:
      - "5432:5432"
    networks:
      - main-network
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

  # 5. Ingestion & Analysis Service - Xử lý dữ liệu & Cảnh báo (Python)
  ingestion-service: # Đổi tên service nếu cần, ví dụ: ingestion-service
    build:
      context: ./ingestion-analysis-service
      dockerfile: Dockerfile
    container_name: ingestion-service
    ports:
      - "3004:3000" # Host Port 3004 -> Container Port 3000
    networks:
      - main-network
    depends_on:
      - orion       # Chờ Orion khởi động
      - postgis  # Chờ PostGIS khởi động (Sử dụng tên service chính xác của bạn)
    environment:
      # Cấu hình Orion
     - ORION_HOST=http://orion:1026
     - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
    # Cấu hình PostGIS (MANDATORY cho Ingestion Service)
    # Host name phải là tên container (db-postgis) hoặc tên service (postgis).
    # Ta sử dụng tên container/hostname đã được định nghĩa.
     - POSTGRES_HOST=postgis 
     - POSTGRES_DB=${POSTGRES_DB} 
     - POSTGRES_USER=${POSTGRES_USER}
     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD} 
    # Cấu hình Alert Service API
     - ALERT_SERVICE_API=http://alert-service:3005/api/alerts/internal/receive 
    # Cấu hình Port cho Uvicorn server nội bộ
     - PORT=3000

networks:
  main-network:
    driver: bridge
