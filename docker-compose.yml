# Copyright 2025 HaUI.DNK
# Licensed under the Apache License, Version 2.0
# http://www.apache.org/licenses/LICENSE-2.0

services:
  gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8000:80" # Map c·ªïng 8000 c·ªßa m√°y b·∫°n v√†o c·ªïng 80 c·ªßa Nginx
    networks:
      - main-network
    depends_on:
      alert-service:
        condition: service_started 
      auth-service:
        condition: service_started
      data-service:
        condition: service_started
      orion:
        condition: service_started

  auth-service:
    build: ./auth-service
    container_name: auth-service
    networks:
      - main-network
    env_file: .env
    depends_on:
      postgis:
        condition: service_healthy # Ch·ªù DB kh·ªèe m·ªõi ch·∫°y
    environment:
      - PORT=3001

  data-service:
    build: ./data-service
    container_name: data-service
    networks:
      - main-network
    env_file: .env
    depends_on:
      postgis:
        condition: service_healthy
    environment:
      - PORT=3002

  weather-realtime-service:
    build: ./weather-realtime-service
    container_name: weather-service
    networks:
      - main-network
    env_file: .env
    environment:
      - PORT=3003
      - ORION_HOST=http://orion:1026

  report-service:
    build: ./report-service
    container_name: report-service
    networks:
      - main-network
    env_file: .env
    environment:
      - PORT=3004
      - ORION_HOST=http://orion:1026

  alert-service:
    build: ./alert-service
    container_name: alert-service
    networks:
      - main-network
    env_file: .env
    depends_on:
      postgis:
        condition: service_healthy
    environment:
      - PORT=3005
      - ORION_HOST=http://orion:1026

  safety-service:
    build: ./safety-service
    container_name: safety-service
    networks: [main-network]
    env_file: .env
    depends_on:
      postgis:
        condition: service_healthy # Ch·ªù DB kh·ªèe m·ªõi ch·∫°y
    environment:
      - PORT=3006

  swagger-ui:
    image: swaggerapi/swagger-ui
    container_name: swagger-ui
    networks:
      - main-network
    environment:
      # C·∫•u h√¨nh danh s√°ch c√°c file JSON t·ª´ c√°c service con
      # URL ph·∫£i d√πng t√™n container (n·ªôi b·ªô docker)
        URLS: > 
          [
            { "url": "http://localhost:8000/api/auth/api-docs.json", "name": "1. Auth Service" },
            { "url": "http://localhost:8000/api/map/api-docs.json", "name": "2. Map API (Data Service) "},
            { "url": "http://localhost:8000/api/weather/api-docs.json", "name": "3. Weather Service" },
            { "url": "http://localhost:8000/api/reports/api-docs.json", "name": "4. Report Service" },
            { "url": "http://localhost:8000/api/alerts/api-docs.json", "name": "5. Alert Service" },
            { "url": "http://localhost:8000/api/safety/api-docs.json", "name": "6. Safety Service" }
          ]

  # 1. MongoDB - C∆° s·ªü d·ªØ li·ªáu cho Orion Context Broker
  mongo:
    image: mongo:4.4
    hostname: mongo
    container_name: db-mongo
    ports:
      - "27017:27017"
    networks:
      - main-network
    command: --nojournal

  # 2. Fiware Orion Context Broker - C·ªët l√µi qu·∫£n l√Ω ng·ªØ c·∫£nh NGSI-LD
  orion:
    image: fiware/orion-ld:latest
    hostname: orion
    container_name: fiware-orion
    restart: always
    command: -dbhost mongo -logLevel DEBUG
    depends_on:
      - mongo
    networks:
      - main-network
    ports:
      - "1026:1026"
    environment:
      - ORION_MONGO_HOST=mongo
      - ORION_MONGO_PORT=27017

  # 3. PostGIS - C∆° s·ªü d·ªØ li·ªáu kh√¥ng gian cho d·ªØ li·ªáu tƒ©nh (V√πng nguy c∆°)
  postgis:
    image: postgis/postgis:latest
    hostname: postgis
    container_name: db-postgis
    ports:
      - "5432:5432"
    networks:
      - main-network
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    # üëá Healthcheck: Ki·ªÉm tra xem DB ƒë√£ s·∫µn s√†ng ch∆∞a
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 5. Ingestion & Analysis Service - X·ª≠ l√Ω d·ªØ li·ªáu & C·∫£nh b√°o (Python)
  ingestion-service: # ƒê·ªïi t√™n service n·∫øu c·∫ßn, v√≠ d·ª•: ingestion-service
    build:
      context: ./ingestion-analysis-service
      dockerfile: Dockerfile
    container_name: ingestion-service
    ports:
      - "3004:3000" # Host Port 3004 -> Container Port 3000
    networks:
      - main-network
    depends_on:
      orion:
        condition: service_started
      data-service: 
        condition: service_started 
      postgis:
        condition: service_healthy
    environment:
      # C·∫•u h√¨nh Orion
     - ORION_HOST=http://orion:1026
     - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
    # C·∫•u h√¨nh PostGIS (MANDATORY cho Ingestion Service)
    # Host name ph·∫£i l√† t√™n container (db-postgis) ho·∫∑c t√™n service (postgis).
    # Ta s·ª≠ d·ª•ng t√™n container/hostname ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.
     - POSTGRES_HOST=postgis 
     - POSTGRES_DB=${POSTGRES_DB} 
     - POSTGRES_USER=${POSTGRES_USER}
     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD} 
    # C·∫•u h√¨nh Alert Service API
     - ALERT_SERVICE_API=http://alert-service:3005
    # C·∫•u h√¨nh Port cho Uvicorn server n·ªôi b·ªô
     - PORT=3000

  frontend:
    build:
      context: ./frontend # Tr·ªè ƒë√∫ng v√†o th∆∞ m·ª•c ch·ª©a code FE
      dockerfile: Dockerfile
    container_name: frontend-app
    restart: always
    ports:
      - "3001:80" # Map c·ªïng 3001 m√°y th·∫≠t v√†o c·ªïng 80 container
    networks:
      - main-network
    depends_on:
      - gateway

networks:
  main-network:
    driver: bridge
