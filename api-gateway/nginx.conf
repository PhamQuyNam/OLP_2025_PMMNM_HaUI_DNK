events { worker_connections 1024; }

http {
    include mime.types;
    default_type application/json;

    upstream swagger_backend { server swagger-ui:8080; } # Swagger mặc định chạy cổng 8080

    # Định nghĩa các cụm Service
    upstream auth_backend {
        server auth-service:3001;
    }

    upstream data_backend {
        server data-service:3002;
    }

    upstream weather_backend {
        server weather-service:3003;
    }

    upstream report_backend {
        server report-service:3004;
    }

    upstream alert_backend {
        server alert-service:3005;
    }

    upstream safety_backend {
        server safety-service:3006;
    }

    upstream orion_backend {
        server orion:1026;
    }

    server {
        listen 80;

        # Cấu hình CORS chung
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' '*' always;

        location /docs/ {
            proxy_pass http://swagger_backend/;
            proxy_set_header Host $host;
            # Cần thiết để Swagger load CSS/JS đúng đường dẫn
            proxy_set_header X-Forwarded-Prefix /docs;
        }

        # --- ROUTE 1: AUTH (Login/Register) ---
        location /api/auth/ {
            if ($request_method = 'OPTIONS') { return 204; }
            proxy_pass http://auth_backend/;
        }

        # --- ROUTE 2: WEATHER (Tách riêng ra) ---
        # Lưu ý: Đặt cái này TRƯỚC cái /api/ chung bên dưới để nó bắt đúng
        location /api/weather/ {
            proxy_pass http://weather_backend/;
        }

        location /api/reports/ {
            proxy_pass http://report_backend/;
        }

        location /api/map/ {
            proxy_pass http://data_backend/;
        }

        location /api/alerts/ {
            proxy_pass http://alert_backend/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        location /api/safety/ {
            proxy_pass http://safety_backend/;
        }

        location /orion/ {
            proxy_pass http://orion_backend/ngsi-ld/;
        }

        location /socket.io/ {
            proxy_pass http://alert_backend/socket.io/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }
    }
}