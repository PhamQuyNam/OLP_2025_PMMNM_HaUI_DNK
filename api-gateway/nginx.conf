events { worker_connections 1024; }

http {
    include mime.types;
    default_type application/json;

    # Định nghĩa các cụm Service
    upstream auth_backend {
        server auth-service:3001;
    }

    upstream data_backend {
        server data-service:3002;
    }

    upstream weather_backend {
        server weather-service:3003;
    }

    upstream report_backend {
        server report-service:3004;
    }

    upstream alert_backend {
        server alert-service:3005;
    }

    upstream orion_backend {
        server orion:1026;
    }

    server {
        listen 80;

        # Cấu hình CORS chung
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' '*' always;

        # --- ROUTE 1: AUTH (Login/Register) ---
        location /api/auth/ {
            if ($request_method = 'OPTIONS') { return 204; }
            proxy_pass http://auth_backend/api/auth/;
        }

        # --- ROUTE 2: WEATHER (Tách riêng ra) ---
        # Lưu ý: Đặt cái này TRƯỚC cái /api/ chung bên dưới để nó bắt đúng
        location /api/weather/ {
            proxy_pass http://weather_backend/;
        }

        location /api/reports/ {
            proxy_pass http://report_backend/;
        }

        location /api/ {
            proxy_pass http://data_backend/api/;
        }

        location /api/alerts/ {
            proxy_pass http://alert_backend/api/alerts/;
        }

        location /orion/ {
            proxy_pass http://orion_backend/ngsi-ld/;
        }
    }
}