events { worker_connections 1024; 
}

http {
    include mime.types;
    default_type application/json;
    sendfile on;
    keepalive_timeout 65;
    # CẤU HÌNH RESOLVER (CẦN THIẾT ĐỂ NGINX PHÂN GIẢI DNS NỘI BỘ)
    # Sử dụng DNS Resolver mặc định của Docker (127.0.0.11)
    resolver 127.0.0.11 valid=5s; 

    server {
        listen 80;
        server_name localhost;

        # Cấu hình CORS chung
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' '*' always;

        # --- ĐỊNH NGHĨA BIẾN SERVICE ĐỘNG (SỬ DỤNG $service_name:port) ---
        set $auth_backend http://auth-service:3001;
        set $data_backend http://data-service:3002;
        set $weather_backend http://weather-service:3003;
        set $report_backend http://report-service:3004;
        set $alert_backend http://alert-service:3005;
        set $safety_backend http://safety-service:3006;
        set $ingestion_backend http://ingestion-service:3000;
        set $orion_backend http://orion:1026;
        set $swagger_backend http://swagger-ui:8080;
        
        # --- ROUTE CỦA TỪNG SERVICE ---

        # 1. AUTH SERVICE
        location /api/auth/ {
            if ($request_method = 'OPTIONS') 
            { 
                return 204; 
            }
            proxy_pass $auth_backend/;
        }

        # 2. DATA SERVICE (MAP API)
        location /api/map/ {
            proxy_pass $data_backend/;
        }

        # 3. ALERT SERVICE
        location /api/alerts/ {
            proxy_pass $alert_backend/;
        }

        # 4. INGESTION SERVICE (NEW)
        location /api/ingestion/ {
            proxy_pass $ingestion_backend/;
        }

        # 5. SWAGGER UI (Để xem API Docs chung)
        location /swagger/ {
            proxy_pass $swagger_backend/;
        }

        # 6. SAFETY SERVICE
        location /api/safety/ {
            proxy_pass $safety_backend/;
        }

        # 7. REPORT SERVICE
        location /api/reports/ {
            proxy_pass $report_backend/;
        }

        # 8. ORION CONTEXT BROKER
        location /orion/ {
            proxy_pass $orion_backend/ngsi-ld/;
        }
    }
    
}